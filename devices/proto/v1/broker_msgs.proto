syntax = "proto3";

package ntt.devices.v1;

option go_package = "github.com/cloudwan/edgelq-sdk/devices/client/v1/broker";
option java_multiple_files = false;
option java_outer_classname = "BrokerCustomProto";
option java_package = "com.ntt.devices.pb.v1";

// Services on the device that the client connects to
//
// SSH protocol overview (distinguish layers)
// ------------------------------------------
// Proxies layer (transport):
// - The SSH service is carried over a Proxies channel.
// - Proxies controls stream open/close and CloseSend/Recv behavior.
// - Transport errors (gRPC stream errors) are surfaced by Proxies, not SSH.
//
// SSH message layer (this proto):
// - The broker only forwards messages; it does not interpret them.
// - Expected order (SSH message layer):
//   1) ClientOut.Hello (exactly once) from consumer to provider.
//   2) Data flow in both directions:
//      - ClientOut.Data (stdin) from consumer to provider.
//      - ClientIn.Data (stdout/stderr) from provider to consumer.
//      - ClientOut.TerminalSize (resize) from consumer to provider.
//   3) ClientIn.ExitStatus (at most once) from provider to consumer, after the
//      remote process exits. No further data should follow ExitStatus.
// - Invalid sequences (examples):
//   - Data after ExitStatus.
//   - Multiple ExitStatus messages.
//   - Transport EOF before Proxies Close.
message SSHService {
  message Hello {
    string user = 1;

    // Command to execute. This field is repeated for backwards compatibility,
    // but only the first item is used. The command should be provided as a
    // single string (not tokenized).
    repeated string command = 2;

    // Environment (optional)
    map<string, string> env = 3;

    // TTY allocation policy.
    TtyMode tty = 4;

    // Initial terminal size (only used when TTY is enabled).
    TerminalSize size = 5;

    enum TtyMode {
      TTY_AUTO = 0;

      TTY_FORCE = 1;

      TTY_DISABLE = 2;
    }
  }

  message TerminalSize {
    uint32 width = 1;

    uint32 height = 2;
  }

  message ExitStatus { int32 code = 1; }

  message ClientOut {
    oneof msg {
      bytes data = 1;

      Hello ssh_hello = 2;

      TerminalSize ssh_resize_terminal = 3;
    }
  }

  message ClientIn {
    oneof msg {
      bytes data = 1;

      ExitStatus exit_status = 2;
    }
  }
}

message SCPService {
  oneof msg {
    // Request to create a directory
    CreateDirectory dir = 1;

    // Request to create a file
    CreateFile file = 2;

    // Request to end SCP transfer
    bool eot = 3;

    // Request SCP configuration
    Configure config = 4;
  }

  message Configure {
    bool recursive = 1;

    Direction direction = 2;

    string path = 3;

    enum Direction {
      DOWNLOAD = 0;

      UPLOAD = 1;
    }
  }

  message CreateDirectory {
    string path = 1;

    uint32 mode = 2;
  }

  message CreateFile {
    oneof msg {
      // Request file initialization
      Initialize init = 1;

      // Request file data
      bytes data = 2;

      // Request to end file transfer
      bool eof = 3;
    }

    message Initialize {
      string path = 1;

      uint32 mode = 2;

      uint64 size = 3;
    }
  }
}

message LogsService {
  // Messages sent only to a device
  message ToDevice {
    // Live follow the logs service
    bool follow = 1;

    // Number of lines to get from the logs service
    uint32 lines = 2;

    // Source of the logs service (e.g. docker container ID)
    string source = 3;
  }

  // Messages sent only to a client
  message ToClient {
    // Logs data
    bytes data = 1;
  }
}

message PodManagementService {
  // Pod state command
  PodState command = 1;

  // Pod to execute the command on
  string pod = 2;

  // Service (container) name to execute the command on (empty = acts on the
  // entire pod)
  string service = 3;

  // Commands for pod state management
  enum PodState {
    // Unspecified pod state
    UNSPECIFIED = 0;

    // Start the pod
    START = 1;

    // Stop the pod
    STOP = 2;

    // Restart the pod
    RESTART = 3;
  }
}

message SystemStateService {
  // Commands for system state management
  enum SystemState {
    // Unspecified system state
    UNSPECIFIED = 0;

    // Shutdown the system
    SHUTDOWN = 1;

    // Reboot the system
    REBOOT = 2;
  }
}

// Broker dedicated messages
enum BrokerServiceType {
  // Service type not specified
  BROKER_SERVICE_UNSPECIFIED = 0;

  // SSH service
  BROKER_SERVICE_SSH_LEGACY = 1;

  BROKER_SERVICE_SSH = 3;

  // TCP port forward service (also used for UDP forwarding)
  BROKER_SERVICE_TCP_FORWARD_PORT = 2;

  // Reboot service
  BROKER_SERVICE_REBOOT = 4;

  // Shutdown service
  BROKER_SERVICE_SHUTDOWN = 5;

  // SCP service
  BROKER_SERVICE_SCP = 6;

  BROKER_SERVICE_SCP_LEGACY = 7;

  // System Logs service
  BROKER_SYS_LOGS = 8;

  // Application (Container) Logs service
  BROKER_APP_LOGS = 9;

  // Pod State Management service
  BROKER_POD_MANAGEMENT = 10;
}
